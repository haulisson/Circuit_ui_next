# ADR-006 — Driver Ports (Input/UI) e Orquestração de Interação (Seleção e Wire)

Status: Proposto
Data: 2025-09-14

## Decisores: Equipe Circuit-Sandbox-Refactor

**Contexto**

Já separamos Domínio (Component/Wire/Schematic) da Application e dos Adapters. Render (Canvas2DRenderer) e Persistência (IndexedDBStore) existem como Driven Ports. Falta padronizar a entrada do usuário (mouse/teclado) para que a UI (Next.js/DOM/Canvas) não acople regras de fluxo (seleção, início/continuação/cancelamento de wire). Também queremos testes sem DOM/Canvas, conforme ADR-003/004.

**Decisão**

Definir Driver Port de Entrada (IInputPort) e Application Controller (InteractionController) com máquina de estados mínima para seleção e desenho de wire.

Eventos canônicos: pointerMove, pointerDown, pointerUp, keyDown (com Escape padronizado).

Fluxo de wire (MVP):

Idle → pointerDown em nó (hit-test fornecido pela Application) → WireDrawing(startNode)

WireDrawing → pointerMove realça nó-alvo se “snappado” → pointerDown cria segmento ortogonal até o ponto/ nó → permanece em WireDrawing

WireDrawing → pointerUp sobre nó → finaliza wire e volta a Idle

WireDrawing → keyDown(Escape) → cancela wire (descarta segmentos) e volta a Idle

Realce de nó é feito via IRenderer.highlight({x,y}); semântica de highlight fica apenas no Adapter de render.

Hit-test é responsabilidade da Application (não do renderer). Ela consulta o modelo (Schematic) e a grade.

Tudo testado com mocks de IInputPort e IRenderer (sem DOM/Canvas).

**Alternativas consideradas**

Tratar eventos direto no Renderer/Canvas: rejeitado (acopla UI ao domínio, dificulta testes).

Colocar hit-test no Renderer: rejeitado (quebra portabilidade do renderer).

**Consequências**

A UI concreta (Next/DOM) só traduz eventos nativos → IInputPort.

Interações ficam previsíveis e testáveis (máquina de estados pura).

ESC funciona de forma consistente em qualquer UI.

Facilita adicionar “snap”, grid, rotação e multi-seleção depois.